import traceback
import sys
from operations import TopOperation
from operations import JoinOperation
from operations import AggregationOperation
from operations import FormulaOperation
from operations import FilterOperation
from connectors import DBFSConnector
from connectors import CosmosDBConnector
from datatransformations import TranformationsMainFlow
from automl import tpot_execution
from core import PipelineNotification
import json

try: 
	PipelineNotification.PipelineNotification().started_notification('5da060549c7544b5ab0f75b6','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify')
	BankDepositAnalysisSourcedbfs = DBFSConnector.DBFSConnector.fetch([], {}, "5da060549c7544b5ab0f75b6", spark, "{'url': '/Demo/BankDepositTrain.csv', 'file_type': 'Delimeted', 'dbfs_token': 'dapib8073bbfa952efa9d363b234ce06e2c6', 'dbfs_domain': 'westus.azuredatabricks.net', 'delimiter': ',', 'is_header': 'Use Header Line'}")

	PipelineNotification.PipelineNotification().completed_notification('5da060549c7544b5ab0f75b6','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify')
except Exception as ex: 
	PipelineNotification.PipelineNotification().failed_notification(ex,'5da060549c7544b5ab0f75b6','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify','http://23.99.85.149:3200/logs/getProductLogs')
	sys.exit(1)
try: 
	PipelineNotification.PipelineNotification().started_notification('5da060549c7544b5ab0f75b7','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify')
	BankDepositAnalysisAutoML = TranformationsMainFlow.TramformationMain.run(["5da060549c7544b5ab0f75b6"],{"5da060549c7544b5ab0f75b6": BankDepositAnalysisSourcedbfs}, "5da060549c7544b5ab0f75b7", spark,json.dumps( {"FE": [{"transformationsData": {}, "feature": "age", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "41.23", "stddev": "11.91", "min": "18", "max": "95", "missing": "0"}}, {"transformationsData": {"feature_label": "job"}, "feature": "job", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "admin.", "max": "unknown", "missing": "0", "distinct": "12"}, "transformation": "String Indexer"}, {"transformationsData": {"feature_label": "marital"}, "feature": "marital", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "divorced", "max": "single", "missing": "0", "distinct": "3"}, "transformation": "String Indexer"}, {"transformationsData": {"feature_label": "education"}, "feature": "education", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "primary", "max": "unknown", "missing": "0", "distinct": "4"}, "transformation": "String Indexer"}, {"transformationsData": {"feature_label": "default"}, "feature": "default", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "no", "max": "yes", "missing": "0", "distinct": "2"}, "transformation": "String Indexer"}, {"transformationsData": {}, "feature": "balance", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "1528.54", "stddev": "3225.41", "min": "-6847", "max": "81204", "missing": "0"}}, {"transformationsData": {"feature_label": "housing"}, "feature": "housing", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "no", "max": "yes", "missing": "0", "distinct": "2"}, "transformation": "String Indexer"}, {"transformationsData": {"feature_label": "loan"}, "feature": "loan", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "no", "max": "yes", "missing": "0", "distinct": "2"}, "transformation": "String Indexer"}, {"transformationsData": {"feature_label": "contact"}, "feature": "contact", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "cellular", "max": "unknown", "missing": "0", "distinct": "3"}, "transformation": "String Indexer"}, {"transformationsData": {}, "feature": "day", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "15.66", "stddev": "8.42", "min": "1", "max": "31", "missing": "0"}}, {"transformationsData": {"feature_label": "month"}, "feature": "month", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "apr", "max": "sep", "missing": "0", "distinct": "12"}, "transformation": "String Indexer"}, {"transformationsData": {}, "feature": "duration", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "371.99", "stddev": "347.13", "min": "2", "max": "3881", "missing": "0"}}, {"transformationsData": {}, "feature": "campaign", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "2.51", "stddev": "2.72", "min": "1", "max": "63", "missing": "0"}}, {"transformationsData": {}, "feature": "pdays", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "51.33", "stddev": "108.76", "min": "-1", "max": "854", "missing": "0"}}, {"transformationsData": {}, "feature": "previous", "transformation": "", "type": "numeric", "replaceby": "mean", "selected": "True", "stats": {"count": "11162", "mean": "0.83", "stddev": "2.29", "min": "0", "max": "58", "missing": "0"}}, {"transformationsData": {"feature_label": "poutcome"}, "feature": "poutcome", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "failure", "max": "unknown", "missing": "0", "distinct": "4"}, "transformation": "String Indexer"}, {"transformationsData": {"feature_label": "deposit"}, "feature": "deposit", "type": "string", "selected": "True", "replaceby": "max", "stats": {"count": "11162", "mean": "", "stddev": "", "min": "no", "max": "yes", "missing": "0", "distinct": "2"}, "transformation": "String Indexer"}, {"feature": "job_transform", "transformation": "", "transformationsData": {}, "type": "real", "selected": "True", "stats": {"count": "1000", "mean": "2.89", "stddev": "2.69", "min": "0.0", "max": "11.0", "missing": "0"}}, {"feature": "marital_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.56", "stddev": "0.69", "min": "0", "max": "2", "missing": "0"}}, {"feature": "education_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.75", "stddev": "0.86", "min": "0", "max": "3", "missing": "0"}}, {"feature": "default_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.02", "stddev": "0.13", "min": "0", "max": "1", "missing": "0"}}, {"feature": "housing_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.46", "stddev": "0.5", "min": "0", "max": "1", "missing": "0"}}, {"feature": "loan_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.12", "stddev": "0.32", "min": "0", "max": "1", "missing": "0"}}, {"feature": "contact_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.34", "stddev": "0.59", "min": "0", "max": "2", "missing": "0"}}, {"feature": "month_transform", "transformation": "", "transformationsData": {}, "type": "real", "selected": "True", "stats": {"count": "1000", "mean": "2.96", "stddev": "2.87", "min": "0.0", "max": "11.0", "missing": "0"}}, {"feature": "poutcome_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.41", "stddev": "0.82", "min": "0", "max": "3", "missing": "0"}}, {"feature": "deposit_transform", "transformation": "", "transformationsData": {}, "type": "numeric", "selected": "True", "stats": {"count": "1000", "mean": "0.46", "stddev": "0.5", "min": "0", "max": "1", "missing": "0"}}]}))

	PipelineNotification.PipelineNotification().completed_notification('5da060549c7544b5ab0f75b7','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify')
except Exception as ex: 
	PipelineNotification.PipelineNotification().failed_notification(ex,'5da060549c7544b5ab0f75b7','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify','http://23.99.85.149:3200/logs/getProductLogs')
	sys.exit(1)
try: 
	PipelineNotification.PipelineNotification().started_notification('5da060549c7544b5ab0f75b8','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify')
	BankDepositAnalysis_AutoML = tpot_execution.Tpot_execution.run(["5da060549c7544b5ab0f75b7"],{"5da060549c7544b5ab0f75b7": BankDepositAnalysisAutoML}, "5da060549c7544b5ab0f75b8", spark,json.dumps( {"model_type": "classification", "label": "deposit", "features": ["age", "job", "marital", "education", "default", "balance", "housing", "loan", "contact", "day", "month", "duration", "campaign", "pdays", "previous", "poutcome"], "percentage": "100", "executionTime": 30, "sampling": "0", "sampling_value": "none", "run_id": "0ece01ebed9f4800a6d95d5b3bba2a13", "model_id": "5e5d041977f12376d1c951db", "ProjectName": "ML Scenarios", "PipelineName": "BankDepositAnalysisDemo", "userid": "5e58ebb7957f3f13254389b5", "runid": "", "url_ResultView": "http://23.99.85.149:3200", "experiment_id": "2341748169460103"}))

	PipelineNotification.PipelineNotification().completed_notification('5da060549c7544b5ab0f75b8','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify')
except Exception as ex: 
	PipelineNotification.PipelineNotification().failed_notification(ex,'5da060549c7544b5ab0f75b8','5e58ebb7957f3f13254389b5','http://23.99.85.149:3200/pipeline/notify','http://23.99.85.149:3200/logs/getProductLogs')
	sys.exit(1)

